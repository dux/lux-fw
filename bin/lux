#!/usr/bin/env ruby
# -*- mode: ruby -*-

if File.exists?('lux-fw.gemspec')
  puts 'Cant run in lux folder'
  exit
end

require 'thor'
require 'colorize'
require 'optparse'
require 'awesome_print'
require 'dotenv'
require_relative '../lib/overload/thread'

Dotenv.load

LUX_ROOT = File.expand_path '../..', __FILE__

puts 'Lux (%s, v%s)' % [LUX_ROOT, File.read('%s/.version' % LUX_ROOT)] unless ARGV[0]

###

module Cli
  extend self

  def run what
    puts what.green
    system what
  end

  def die text
    puts text.red
    exit
  end

  def info text
    puts '* %s' % text.magenta
  end
end

###

trap("SIGINT") { Cli.die 'ctrl+c exit' }

LuxCli = Class.new Thor

Dir['%s/bin/cli/*.rb' % LUX_ROOT].each { |it| load it }

LuxCli.start ARGV

###

unless ARGV[0]
  t = Thread::Simple.new
  t.add(:rake) { `rake -T` }      if (Dir['./Rakefile*'] + Dir['./rakefile*'])[0]
  t.add(:capistrano) { `cap -T` } if File.exist?('./Capfile')
  t.run

  if t[:rake]
    puts 'Rake tasks:'
    puts '  ' + t[:rake].gsub($/, "\n  ")
  end

  if t[:capistrano]
    puts 'Capinstrano tasks:'
    puts '  ' + t[:capistrano].gsub($/, "\n  ")
  end
end

